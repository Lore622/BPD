# VT/kg
m_VTkg <- glmmTMB(
Tidal_volume ~ Time + BPD * hsPDA + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_VTkg)
performance::check_model(m_VTKg)
performance::check_model(m_VTkg)
summary(df_mod$Tidal_volume)
summary(df_mod$m_tPTEF)
summary(df_mod$Time_PTEF)
plot(df_mod$Time_PTEF)
plot(df_mod$Time_PTEF,hline="red")
?plot
plot((df_mod$Tidal_volume))
p_hist_dens_Volume <- ggplot(df_mod, aes(x = Tidal_volume)) +
geom_histogram(
aes(y = after_stat(density)),
bins = 25,
fill = "grey85",
color = "black",
linewidth = 0.35
) +
geom_density(
color = "red3",   # se la vuoi rossa
linewidth = 1,
trim = TRUE,
cut = 0
) +
coord_cartesian(xlim = c(x_min, x_max)) +
labs(
title = "Distribution of RR",
x = "RR",
y = "Density"
) +
theme_classic(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
axis.line = element_line(color = "black"),
axis.ticks = element_line(color = "black")
)
p_hist_dens_Volume <- ggplot(df_mod, aes(x = Tidal_volume)) +
geom_histogram(
aes(y = after_stat(density)),
bins = 25,
fill = "grey85",
color = "black",
linewidth = 0.35
) +
geom_density(
color = "red3",   # se la vuoi rossa
linewidth = 1,
trim = TRUE
) +
coord_cartesian(xlim = c(x_min, x_max)) +
labs(
title = "Distribution of RR",
x = "RR",
y = "Density"
) +
theme_classic(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
axis.line = element_line(color = "black"),
axis.ticks = element_line(color = "black")
)
p_hist_dens_Volume
length(unique(df_mod$ID))
length(unique(df_mod$Grado123))
unique(df_mod$Grado123))
unique(df_mod$Grado123)
head(df_mod)
View(df_mod)
table(df_mod$ID,df_mod$Grado123)
ifelse(is.na(df_mod$Grado123,0,Grado123))
df_mod$Grado123<-felse(is.na(df_mod$Grado123),0,df_mod$Grado123)
df_mod$Grado123<-ifelse(is.na(df_mod$Grado123),0,df_mod$Grado123)
uniqe(df_mod$Grado123)
unique(df_mod$Grado123)
View(df_mod)
library(dplyr)
library(glmmTMB)
df_sens <- df_mod %>%
mutate(
BPD_sev = case_when(
Grado123 == 0 ~ "noBPD",
BPD_Jensen == 1 & Grado123 == 1 ~ "mild",
BPD_Jensen == 1 & Grado123 == 2 ~ "moderate",
BPD_Jensen == 1 & Grado123 == 3 ~ "severe",
TRUE ~ NA_character_
),
BPD_sev = factor(BPD_sev, levels = c("noBPD", "mild", "moderate", "severe"))
) %>%
filter(!is.na(BPD_sev))
library(dplyr)
library(ggplot2)
# Frequenze della severità SOLO tra i BPD (Grado123 = 1/2/3)
freq_sev <- df_mod %>%
filter(BPD_Jensen == 1, !is.na(Grado123)) %>%
mutate(Grado123 = factor(Grado123, levels = c(1,2,3),
labels = c("mild (1)", "moderate (2)", "severe (3)"))) %>%
count(Grado123, name = "n")
freq_sev
ggplot(freq_sev, aes(x = Grado123, y = n)) +
geom_col() +
geom_text(aes(label = n), vjust = -0.4) +
labs(x = "BPD severity (Jensen grade)", y = "Number of observations",
title = "Distribuzione della severità BPD (solo soggetti con BPD)") +
theme_classic(base_size = 14)
df_sens <- df_mod %>%
mutate(
BPD_sev = case_when(
Grado123 == 0 ~ "noBPD",
BPD_Jensen == 1 & Grado123 == 1 ~ "mild",
BPD_Jensen == 1 & Grado123 == 2 ~ "moderate",
BPD_Jensen == 1 & Grado123 == 3 ~ "severe",
TRUE ~ NA_character_
),
BPD_sev = factor(BPD_sev, levels = c("noBPD", "mild", "moderate", "severe"))
) %>%
filter(!is.na(BPD_sev))
nrow(BPD_sev)
nrow(df_mod$Grado123)
length(df_mod$Grado123)
df_sens <- df_mod %>%
mutate(
BPD_sev = case_when(
Grado123 == 0 ~ "noBPD",
BPD_Jensen == 1 & Grado123 == 1 ~ "mild",
BPD_Jensen == 1 & Grado123 == 2 ~ "moderate",
BPD_Jensen == 1 & Grado123 == 3 ~ "severe",
TRUE ~ NA_character_
),
BPD_sev = factor(BPD_sev, levels = c("noBPD", "mild", "moderate", "severe"))
) %>%
filter(!is.na(BPD_sev))
View(df_sens)
aggregate(df_sens$ID,df_sens$BPD_sev)
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=count)
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=sum)
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=length)
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique)
)
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique))
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique()))
aggregate(x=df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique(x)))
aggregate(x=df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique(x)))
aggregate(df_sens$BPD_sev ~ df_sens$ID, FUN=length(unique()))
freq_sev <- df_mod %>%
filter(BPD_Jensen == 1, !is.na(Grado123)) %>%
distinct(ID, Grado123) %>%   # <-- una riga per ID (con la sua severità)
mutate(Grado123 = factor(
Grado123, levels = c(1,2,3),
labels = c("mild (1)", "moderate (2)", "severe (3)")
)) %>%
count(Grado123, name = "n_subj")
ggplot(freq_sev, aes(x = Grado123, y = n_subj)) +
geom_col() +
geom_text(aes(label = n_subj), vjust = -0.4) +
labs(x = "BPD severity (Jensen grade)", y = "Number of subjects (unique ID)",
title = "Distribuzione severità BPD (solo soggetti con BPD)") +
theme_classic(base_size = 14)
rm(list=ls())
library(readxl)
library(dplyr)
library(stringr)
library(tidyr)
library(tibble)
library(readr)
library(ggplot2)
library(glmmTMB)
df_or<-read_excel("DATI/DATABASE Lorenzo.xlsx")
unique(df_or$`2CurvaFV(mesiEC)`)
df_raw <- read_excel("DATI/DF_Lore.xlsx")
#View(df_raw)
summary(df_raw)
head(df_raw)
names(df_raw)
#ho modificato a mano gli ID TRAKCARE usando codice LA + numero
# adesso controlliamo che ogni soggetto ha un ID differente
check_ID<-df_raw %>% count(df_raw$ID)
summary(check_ID)
unique(df_raw$Time_2)
class(df_raw$Time_1)
class(df_raw$Time_2)
df_long <- df_raw %>%
pivot_longer(
cols = matches("_(\\d+)$"),   # tutte le colonne che finiscono con _numero
names_to = c(".value", "timepoint"),
names_pattern = "^(.*)_(\\d+)$"
) %>%
mutate(timepoint = as.integer(timepoint))
#check:
grep("tPTE", names(df_long), value = TRUE)
head(df_long)
#vedo che mancano tante osservazioni soprattutto ai primi timepoint:
#controlliamo:
#quanti soggetti hanno outcome in ciascun timepoint
df_long %>%
filter(!is.na(tPTEF_perc_tE)) %>%
distinct(ID, timepoint) %>%
count(timepoint)
#Guarda quante osservazioni valide dell’outcome hai per timepoint:
df_long %>%
group_by(timepoint) %>%
summarise(
n_outcome = sum(!is.na(tPTEF_perc_tE)),
n_time    = sum(!is.na(Time)),
n_both    = sum(!is.na(Time) & !is.na(tPTEF_perc_tE))
)
n_valid <- df_long %>%
filter(!is.na(Time), !is.na(tPTEF_perc_tE)) %>%
count(ID, name = "n_valid")
summary(n_valid$n_valid)
table(n_valid$n_valid)
n_valid %>% arrange(n_valid) %>% head(10)
#vediamo se abbiamo perso osservazioni nel passaggio
#da wide a long:
out_cols <- grep("^tPTEF%tE \\(mean\\) preB2", names(df_or), value = TRUE)
out_cols
length(out_cols)
colSums(!is.na(df_or[, out_cols, drop = FALSE]))
wide_counts <- df_or %>%
transmute(
ID = ID,
n_out_wide = rowSums(!is.na(across(all_of(out_cols))))
)
summary(wide_counts$n_out_wide)
table(wide_counts$n_out_wide)
long_counts <- df_long %>%
group_by(ID) %>%
summarise(n_out_long = sum(!is.na(tPTEF_perc_tE)), .groups = "drop")
summary(long_counts$n_out_long)
table(long_counts$n_out_long)
chk <- wide_counts %>%
inner_join(long_counts, by = "ID") %>%
mutate(diff = n_out_wide - n_out_long)
table(chk$diff)
chk %>% filter(diff != 0) %>% arrange(desc(abs(diff)))
df_long %>%
filter(!is.na(tPTEF_perc_tE)) %>%
count(timepoint) %>%
ggplot(aes(x = factor(timepoint), y = n)) +
geom_col(fill = "grey80", color = "black") +
labs(x = "Timepoint", y = "Number of observations",
title = "Number of valid tPTEF%tE observations by timepoint") +
theme_classic(base_size = 14)
df_use <- df_long %>% filter(!is.na(tPTEF_perc_tE))
x_min <- min(df_use$tPTEF_perc_tE, na.rm = TRUE)
x_max <- max(df_use$tPTEF_perc_tE, na.rm = TRUE)
# -----------------------
# 1) HISTOGRAM (count)
# -----------------------
p_hist_dens <- ggplot(df_use, aes(x = tPTEF_perc_tE)) +
geom_histogram(
aes(y = after_stat(density)),
bins = 25,
fill = "grey85",
color = "black",
linewidth = 0.35
) +
geom_density(
color = "red3",   # se la vuoi rossa
linewidth = 1,
trim = TRUE,
cut = 0
) +
coord_cartesian(xlim = c(x_min, x_max)) +
labs(
title = "Distribution of tPTEF%tE",
x = "tPTEF%tE",
y = "Density"
) +
theme_classic(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
axis.line = element_line(color = "black"),
axis.ticks = element_line(color = "black")
)
p_hist_dens
# Controlliamo quanti NA ci sono nelle variabili che vuoi usare nel modello
colSums(is.na(df_long[, c("Time", "tPTEF_perc_tE", "BPD_Jensen", "HSPDAgg", "sex1M2F", "LOS", "PH")]))
df_mod <- df_long %>%
filter(!is.na(Time), !is.na(tPTEF_perc_tE),!is.na(PH)) %>%
mutate(
ID = factor(ID),
BPD = factor(BPD_Jensen, levels = c(0,1)),#0=No;1=YES
sex = factor(sex1M2F, levels = c(1,2)),#1=M;2=F
LOS = factor(LOS),
PH  = factor(PH),
GA=  as.numeric(EG),
hsPDA = as.numeric(HSPDAgg)
)
vars_model <- c("Time","tPTEF_perc_tE","BPD","hsPDA","GA","sex","LOS","PH")
colSums(is.na(df_mod[, vars_model]))
###salviamolo
library(here)
out_dir  <- here("data", "derived")
out_file <- here("data", "derived", "df_mod.rds")
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
saveRDS(df_mod, out_file)
# (A) Modello “livello medio” (più semplice)
m_level <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD*HSPDAgg + GA + sex + LOS + PH +
(1 + Time | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_level)
m_level0 <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD*hsPDA + GA + sex + LOS + PH +
(1 |  ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_level0)
# Salva m_level0
saveRDS(m_level0, here("data", "derived", "m_level0.rds"))
#oppure piu semplicemente:
library(performance)
performance::check_model(m_level0)
check_model(m_level0)
r2(m_level0)
#altra diagnostica con DHARMA:
# simulare dati dal modello
#fittato e confrontarli con i dati osservati.
library(DHARMa)
# Crea residui simulati (di default 250 simulazioni)
sim_res <- simulateResiduals(m_level0, n = 1000)
# Plot diagnostico complessivo
plot(sim_res)
testUniformity(sim_res) # Test KS per uniformità dei residui
# (B) Modello “traiettorie” (più aderente al razionale del Word)
m_traj <- glmmTMB(
tPTEF_perc_tE ~ Time * BPD * hsPDA + GA + sex + LOS + PH +
(1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_traj)
#diagnostica:
library(performance)
check_model(m_traj)
r2(m_traj)
library(DHARMa)
# Crea residui simulati (di default 250 simulazioni)
sim_res_t <- simulateResiduals(m_traj, n = 1000)
# Plot diagnostico complessivo
plot(sim_res_t)
AIC(m_level0, m_traj)
BIC(m_level0, m_traj)
m_sens_BW <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD * hsPDA + PN + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
# RR
m_RR <- glmmTMB(
RR ~ Time + BPD * hsPDA + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_RR)
library(performance)
check_model(m_RR)
summary(df_mod$RR)
p_hist_dens_RR <- ggplot(df_mod, aes(x = RR)) +
geom_histogram(
aes(y = after_stat(density)),
bins = 25,
fill = "grey85",
color = "black",
linewidth = 0.35
) +
geom_density(
color = "red3",   # se la vuoi rossa
linewidth = 1,
trim = TRUE,
cut = 0
) +
coord_cartesian(xlim = c(x_min, x_max)) +
labs(
title = "Distribution of RR",
x = "RR",
y = "Density"
) +
theme_classic(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
axis.line = element_line(color = "black"),
axis.ticks = element_line(color = "black")
)
p_hist_dens_RR
# VT/kg
m_VTkg <- glmmTMB(
Tidal_volume ~ Time + BPD * hsPDA + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_VTkg)
performance::check_model(m_VTkg)
summary(df_mod$Tidal_volume)
plot((df_mod$Tidal_volume))
plot(df_mod$Time_PTEF)
length(unique(df_mod$ID))
unique(df_mod$Grado123)
head(df_mod)
table(df_mod$ID,df_mod$Grado123)
df_mod$Grado123<-ifelse(is.na(df_mod$Grado123),0,df_mod$Grado123)
unique(df_mod$Grado123)
nrow(df_mod$Grado123)
length(df_mod$Grado123)
library(dplyr)
library(glmmTMB)
df_sens <- df_mod %>%
mutate(
BPD_sev = case_when(
Grado123 == 0 ~ "noBPD",
BPD_Jensen == 1 & Grado123 == 1 ~ "mild",
BPD_Jensen == 1 & Grado123 == 2 ~ "moderate",
BPD_Jensen == 1 & Grado123 == 3 ~ "severe",
TRUE ~ NA_character_
),
BPD_sev = factor(BPD_sev, levels = c("noBPD", "mild", "moderate", "severe"))
) %>%
filter(!is.na(BPD_sev))
library(dplyr)
library(ggplot2)
freq_sev <- df_mod %>%
filter(BPD_Jensen == 1, !is.na(Grado123)) %>%
distinct(ID, Grado123) %>%   # <-- una riga per ID (con la sua severità)
mutate(Grado123 = factor(
Grado123, levels = c(1,2,3),
labels = c("mild (1)", "moderate (2)", "severe (3)")
)) %>%
count(Grado123, name = "n_subj")
ggplot(freq_sev, aes(x = Grado123, y = n_subj)) +
geom_col() +
geom_text(aes(label = n_subj), vjust = -0.4) +
labs(x = "BPD severity (Jensen grade)", y = "Number of subjects (unique ID)",
title = "Distribuzione severità BPD (solo soggetti con BPD)") +
theme_classic(base_size = 14)
m_sev <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD_sev * hsPDA + GA + sex + LOS + PH + (1|ID),
family = Gamma(link="log"),
data = df_sens
)
summary(m_sev)
# 4. Categorico PDA: 0 / 1–7 / >7 per robustezza,
df_pda_cat <- df_mod %>%
mutate(
hsPDA_cat = cut(hsPDA, breaks = c(-Inf, 0, 7, Inf),
labels = c("0", "1-7", ">7")),
hsPDA_cat = relevel(hsPDA_cat, ref = "0")
)
m_pda_cat <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD * hsPDA_cat + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_pda_cat
)
summary(m_pda_cat)
df_piece <- df_mod %>%
mutate(
pda_0_7 = pmin(hsPDA, 7),
pda_gt7 = pmax(hsPDA - 7, 0)
)
m_piece <- glmmTMB(
tPTEF_perc_tE ~ Time + BPD * (pda_0_7 + pda_gt7) + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_piece
)
summary(m_piece)
AIC(m_level0, m_sev, m_pda_cat, m_piece)
# Cartella target (Windows-friendly)
models_dir <- "C:/Users/39348/Desktop/BPD/data/derived/models"
dir.create(models_dir, recursive = TRUE, showWarnings = FALSE)
models <- list(
m_level0  = m_level0,
m_traj    = m_traj,
m_sens_BW = m_sens_BW,
m_RR      = m_RR,
m_VTkg    = m_VTkg,
m_tPTEF   = m_tPTEF,
m_sev     = m_sev,
m_pda_cat = m_pda_cat,
m_piece   = m_piece
)
saveRDS(models, file = file.path(models_dir, "all_models.rds"))
# tPTEF
m_tPTEF <- glmmTMB(
Time_PTEF ~ Time + BPD * hsPDA + GA + sex + LOS + PH + (1 | ID),
family = Gamma(link = "log"),
data = df_mod
)
summary(m_tPTEF)
# Cartella target (Windows-friendly)
models_dir <- "C:/Users/39348/Desktop/BPD/data/derived/models"
dir.create(models_dir, recursive = TRUE, showWarnings = FALSE)
models <- list(
m_level0  = m_level0,
m_traj    = m_traj,
m_sens_BW = m_sens_BW,
m_RR      = m_RR,
m_VTkg    = m_VTkg,
m_tPTEF   = m_tPTEF,
m_sev     = m_sev,
m_pda_cat = m_pda_cat,
m_piece   = m_piece
)
saveRDS(models, file = file.path(models_dir, "all_models.rds"))
source("~/.active-rstudio-document", echo=TRUE)
