---
title: "Analisi di sensibilità"
author: "Lorenzo Atzeni"
editor: visual
format:
  html:
    self-contained: true
    number-sections: false
---

## Sensitivity Analysis

In questa pagina sono presenti le **analisi di sensitività/robustezza** per verificare se le conclusioni del modello principale (m_level0=\> tPTEF%tE \~ BPD × hsPDA ) **cambiano** quando modifichiamo la definizione delle esposizioni. In particolare: (i) sostituiamo BPD binaria con **BPD per severità** (no/mild/moderate/severe), e (ii) ricodifichiamo hsPDA da continuo a **categorie cliniche** (0, 1–7, \>7) o a una forma **piecewise** (effetto 0–7 distinto dall’effetto oltre 7), così da testare l’ipotesi di una “critical window” e confrontare i modelli anche tramite **AIC**.

## 1) **BPD per severità** (no/mild/moderate/severe)

```{r, echo=F}
library(glmmTMB)
library(readr)
library(here)
library(dplyr)
library(ggplot2)

df_mod <- readRDS(here("data", "derived", "df_mod.rds"))
```

Vediamo come si distribuiscono i punteggi della severità di BPD:

```{r,echo=F}


freq_sev <- df_mod %>%
    filter(BPD_Jensen == 1, !is.na(Grado123)) %>%
    distinct(ID, Grado123) %>%   # <-- una riga per ID (con la sua severità)
    mutate(Grado123 = factor(
      Grado123, levels = c(1,2,3),
      labels = c("mild (1)", "moderate (2)", "severe (3)")
    )) %>%
    count(Grado123, name = "n_subj")
  
  
  ggplot(freq_sev, aes(x = Grado123, y = n_subj)) +
    geom_col() +
    geom_text(aes(label = n_subj), vjust = -0.4) +
    labs(x = "BPD severity (Jensen grade)", y = "Number of subjects (unique ID)",
         title = "Distribuzione severità BPD (solo soggetti con BPD)") +
    theme_classic(base_size = 14)
  
  
  
```

La categoria mild è scarsamente rappresentata (n=1), pertanto le stime specifiche per mild (in particolare le interazioni con hsPDA) non sono interpretabili; il modello viene usato solo come analisi esplorativa/sensitività. Si può fittare il modello ma ci saranno celle vuote/scarsamente popolate nelle combinazioni BPD_sev × hsPDA e ovviamente alcune interazioni non saranno stimabili (termini rimossi per rank-deficiency). Pertanto, il modello non consente inferenze affidabili specifiche per il livello mild.

Alternative migliori per un'eventuale pubblicazione potrebbero essere il collassare quindi unire mild + moderate e fare un modello solo con moderate+severe vs noBPD.

```{r, echo=F}

df_sens <- df_mod %>%
  mutate(
    BPD_sev = case_when(
      BPD_Jensen == 0 ~ "noBPD",
      BPD_Jensen == 1 & Grado123 == 1 ~ "mild",
      BPD_Jensen == 1 & Grado123 == 2 ~ "moderate",
      BPD_Jensen == 1 & Grado123 == 3 ~ "severe",
      TRUE ~ NA_character_
    ),
    BPD_sev = factor(BPD_sev, levels = c("noBPD", "mild", "moderate", "severe"))
  ) %>%
  filter(!is.na(BPD_sev))


m_sev <- glmmTMB(
  tPTEF_perc_tE ~ Time + BPD_sev * hsPDA + GA + sex + LOS + PH + (1|ID),
  family = Gamma(link="log"),
  data = df_sens
)
summary(m_sev)
```

## 2) Categorico PDA: 0 / 1–7 / \>7

Vediamo anche qui la frequenza:

```{r,echo=F}
df_sens <- df_sens %>%
  mutate(
    hsPDA_cat = cut(HSPDAgg,
                    breaks = c(-Inf, 0, 7, Inf),
                    labels = c("0", "1-7", ">7")),
    hsPDA_cat = relevel(hsPDA_cat, ref = "0")
  )
df_sens %>%
  distinct(ID, hsPDA_cat) %>%
  count(hsPDA_cat) %>%
  ggplot(aes(x = hsPDA_cat, y = n)) +
  geom_col(fill = "grey80", color = "black") +
  theme_classic() +
  labs(x = "hsPDA category", y = "Number of subjects (unique ID)")

```

```{r}
df_pda_cat <- df_mod %>%
  mutate(
    hsPDA_cat = cut(hsPDA, breaks = c(-Inf, 0, 7, Inf),
                    labels = c("0", "1-7", ">7")),
    hsPDA_cat = relevel(hsPDA_cat, ref = "0")
  )

m_pda_cat <- glmmTMB(
  tPTEF_perc_tE ~ Time + BPD * hsPDA_cat + GA + sex + LOS + PH + (1 | ID),
  family = Gamma(link = "log"),
  data = df_pda_cat
)
summary(m_pda_cat)


```

## 3) Piecewise (0–7 e \>7)

```{r}

df_piece <- df_mod %>%
  mutate(
    pda_0_7 = pmin(hsPDA, 7),
    pda_gt7 = pmax(hsPDA - 7, 0)
  )

m_piece <- glmmTMB(
  tPTEF_perc_tE ~ Time + BPD * (pda_0_7 + pda_gt7) + GA + sex + LOS + PH + (1 | ID),
  family = Gamma(link = "log"),
  data = df_piece
)

summary(m_piece)


```

Confrontiamo i modelli:

```{r}
m_level0 <- readRDS(here("data", "derived", "m_level0.rds"))
AIC(m_level0, m_sev, m_pda_cat, m_piece)
BIC(m_level0, m_sev, m_pda_cat, m_piece)
```

Nel complesso, le analisi di sensitività **non modificano in modo sostanziale le conclusioni** del modello principale.

<a href="outcome_secondari.html" class="btn btn-primary">← Torna indietro</a>
